<p>例えばあるプロセスからあるプロセスへ、Aというメッセージを送った後にBというメッセージを送るコードを書いた場合、受信側はA, Bという順序で受信することが保証されているかどうか、というのが気になったので調べました。</p>

<h2>
<span id="結論から" class="fragment"></span><a href="#%E7%B5%90%E8%AB%96%E3%81%8B%E3%82%89"><i class="fa fa-link"></i></a>結論から</h2>

<p>順序は保証されるようです。</p>

<ul>
<li><a href="http://erlang.org/faq/academic.html#idp33232112" rel="nofollow noopener" target="_blank">10.8  Is the order of message reception guaranteed?</a></li>
</ul>

<p>受信側にBというメッセージが届いてるなら、Aというメッセージはそれより前に到着してることが保証されている、とのこと。</p>

<p>少なくとも同じノード内だけは順序が保証されて欲しいと思っていたのですが、これを見る限りノードを超えても順序は保証されてそうです。</p>

<h2>
<span id="到達保証" class="fragment"></span><a href="#%E5%88%B0%E9%81%94%E4%BF%9D%E8%A8%BC"><i class="fa fa-link"></i></a>到達保証</h2>

<p>もう一つ疑問に思ったのは、メッセージが届く保証がどのレベルであるのかということです。</p>

<p>メッセージは、直感的には、必ず、1回だけ届くことを期待します。<br>
つまり、あるメッセージが届かないなんてことは考えないし、同じメッセージが2回届くことなんて考えません。<br>
しかし、ネットワークを超えたメッセージのやりとりでは、ネットワークが一瞬切断されて復活した、みたいな場合に以下のようなことがありがちです。</p>

<ul>
<li>受信側に、メッセージAが届かず、その次のメッセージBだけが届く</li>
<li>受信側にメッセージAは届いたのだけど、無事受信できたというACKが送信側に届かず、送信側がメッセージAが届かなかったと勘違いして再度メッセージAを送信する。そのためメッセージAが2回届く</li>
</ul>

<p>ノードを超えてメッセージをやり取りした際に、受信側がこれらのケースを考慮する必要があるかどうかが気になるところです。</p>

<p>これに関しても同じような場所に答えが載っていました。</p>

<ul>
<li><a href="http://erlang.org/faq/academic.html#idp33057520" rel="nofollow noopener" target="_blank">10.9  If I send a message, is it guaranteed to reach the receiver?</a></li>
</ul>

<p>これを読む限り、条件付きだけれども、必ず1回届くという保証なっているようです。<br>
2回以上届くことはない、と明確に言ってくれてる訳ではないですが、2回以上届く可能性があるなら、「TCPと同程度の保証がある」みたいな書き方はしないはずなので、多分大丈夫でしょう。</p>

<p>条件付き、というのは、ネットワークやプロセスがクラッシュしたりするとメッセージが届かなくなるし、それらの情報は失われるということです。<br>
ただし、必ず1回届く、という保証から考えると、ある時点から全てのメッセージが届かなくなるということはあっても、途中のメッセージが抜けてしまった状態で受信したり、複数回同じメッセージを受信したりなどの現象は起きないはずです。</p>

<p>また、<code>link/1</code>や<code>monitor/2</code>などで監視してれば、そのプロセスが何かおかしくなったということが分かるし、確実に処理されたことを保証したいなら <code>gen_server:call/3</code> やそれに相当する処理を書けばいいので、それらを使えばうまいことハンドリングできそうです。</p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>Erlangのメッセージは、同じプロセスから送ったメッセージの順序が保証されていて、それらのメッセージは何らかの問題が起きるまで必ず1回だけ届くことが保証されています。</p>

<p>要するに <strong>あれこれ考えず普通にメッセージ送受信するコードを書けば普通に動く</strong> ので、難しいことは考えず普通に書きましょう。</p>
